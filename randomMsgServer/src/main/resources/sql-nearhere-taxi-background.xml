<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.nearhere.taxi.background">

	<select id="getAllPosts" parameterType="java.util.HashMap" resultType="com.nearhere.domain.Post">
		select * from post
	</select>

	<update id="updatePostDepartureDateTime" parameterType="com.nearhere.domain.Post">
		update post set departureDateTime=#{departureDateTime} where postID=#{postID}
	</update>
	
	<select id="getPostsNotYetFinished" resultType="com.nearhere.domain.Post">
		<![CDATA[
			select * from post 
			where status <> '종료됨'
			and deletedDate is null
			and type='taxi'
			order by postID desc
			limit 0, 50;
		]]> 	
	</select>
	
	<update id="updatePostAsFinished" parameterType="java.util.List" >
		update post set status='종료됨', finishedBySystem='Y'
		where postID in (
		<foreach item="Post" collection="list" open="" close=""
			separator=",">
			#{Post.postID}
		</foreach>
		)
	</update>
	
	<select id="selectPostsRegionNull" resultType="com.nearhere.domain.Post">
		<![CDATA[
			select * from post
			where region is null
			and type='taxi';
		]]> 	
	</select>
	
	<select id="selectRegionNo" resultType="String" parameterType="String">
		<![CDATA[
			select regionNo from region
			where regionName=#{regionName}
		]]> 	
	</select>
	
	<update id="updatePostRegion" parameterType="com.nearhere.domain.Post">
		<![CDATA[
			update post set region=#{region}
			where postID = #{postID};
		]]> 	
	</update>
	
	<!-- 푸쉬 보낼 합승내역을 읽어온다. -->
	<select id="getPushJobList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
			select j.*, p.fromLatitude, p.fromLongitude, p.fromAddress, p.latitude, p.longitude, p.toAddress 
			from push_job j
				left outer join post p on p.postID=j.param
			where j.pushType='newPost'
			and (j.finishYN is null or j.finishYN <> 'Y')
		]]> 	
	</select>
	
	<select id="getUserListAroundPost" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
			select * from (
				select TRUNCATE((
								6371 * acos ( cos ( radians( #{latitude} )
								)
								* cos( radians( latitude ) )
								* cos( radians( longitude ) -
								radians( #{longitude} ) )
								+ sin ( radians( #{latitude} ) )
								*
								sin( radians( latitude ) )
								)
								) , 1) AS distance, ul.*
				from (
					select l.*, u.regID from user_location l
						left outer join user u on l.userID=u.userID
					where u.isDeleted is null
					and l.locationName <> '현재위치'
					and u.regID is not null
					and l.latitude <> 0 and l.longitude <> 0
				) ul
			) A
			where distance < 3
			order by distance
		]]> 	
	</select>
	
	<update id="updatePushJobAsFinished" parameterType="java.util.HashMap">
		<![CDATA[
			update push_job set finishYN='Y', finishedDate = NOW()
			where param = #{param};
		]]> 	
	</update>
	
</mapper>