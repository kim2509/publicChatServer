<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dy.mapper">

	<select id="getUserCount" resultType="int">
		select count(userNo) from
		USER;
	</select>

	<insert id="insertUser" parameterType="com.dy.domain.User"
		useGeneratedKeys="true" keyProperty="userNo" keyColumn="userNo">
		INSERT INTO USER( createDate, lastLoginDate )
		VALUES( NOW(), NOW() );
		<selectKey keyProperty="userNo" resultType="long" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>

	<insert id="insertUserLocation" parameterType="com.dy.domain.User">
		INSERT INTO
		USER_LOCATION( userNo, locationName, latitude, longitude )
		VALUES(
		#{userNo}, 'LOGIN_LOCATION', #{latitude}, #{longitude} );
	</insert>

	<update id="updateUserLocation" parameterType="com.dy.domain.User">
		UPDATE
		USER_LOCATION SET latitude=#{latitude}, longitude=#{longitude} where
		userNo=#{userNo}
	</update>

	<select id="getUser" resultType="com.dy.domain.User"
		parameterType="string">
		select U.userNo, userID, userName, nickName, createDate,
		lastLoginDate, sex, birthYear, latitude, longitude
		from USER U
		left outer join USER_LOCATION UL on U.userNo=UL.userNo
		where U.userNo = #{userNo}
	</select>

	<update id="updateUserSex" parameterType="com.dy.domain.User">
		UPDATE USER SET
		sex=#{sex} where userNo=#{userNo}
	</update>

	<update id="updateUserAge" parameterType="com.dy.domain.User">
		UPDATE USER SET
		birthYear=#{birthYear} where userNo=#{userNo}
	</update>

	<select id="getUserProfileKeywordDic" resultType="com.dy.domain.UserProfileKeywordDic">
		SELECT * FROM
		USER_PROFILE_KEYWORD_DIC;
	</select>

	<delete id="deleteUserProfileKeywords" parameterType="com.dy.domain.UserProfileKeyword">
		delete from USER_PROFILE_KEYWORD where userNo=#{userNo}
	</delete>

	<!-- Batch Insert example, using the Account parameter class -->
	<insert id="batchInsertUserProfileKeywords" parameterType="java.util.List">
		replace into USER_PROFILE_KEYWORD (
		userNo, keywordNo
		)
		values (
		<foreach item="UserProfileKeyword" collection="list" open="" close=""
			separator="),(">
			#{UserProfileKeyword.userNo}, #{UserProfileKeyword.keywordNo}
		</foreach>
		)
	</insert>
	
	<select id="getUsersNearMe" parameterType="com.dy.domain.User" resultType="java.util.HashMap">
		<![CDATA[
		SELECT userNo, TRUNCATE((
    		6371 * acos ( cos ( radians( #{latitude} ) )
      		* cos( radians( latitude ) )
      		* cos( radians( longitude ) - radians( #{longitude} ) )
      		+ sin ( radians( #{latitude} ) )
      		* sin( radians( latitude ) )
    		)
  			) , 1)  AS distance
			FROM USER_LOCATION
			WHERE userNo <> #{userNo}
			ORDER BY distance
			LIMIT 0 , 20;
		]]>
	</select>
	
	<select id="existChatHistory" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		<![CDATA[
		SELECT * FROM CHAT_ROOM_USERS
		WHERE ROOM_ID in
			(SELECT ROOM_ID FROM CHAT_ROOM_USERS WHERE userNo=#{userNo})
		AND userNo <> #{userNo}
		AND userNo in (#{anotherUserNo})
		]]>
	</select>
	
	<insert id="insertChatRoom" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="roomID" keyColumn="roomID">
		INSERT INTO CHAT_ROOMS(userNo, createDate)
		values(#{userNo}, NOW());
		<selectKey keyProperty="roomID" resultType="long" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<insert id="createChatRoomTable" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="roomID" keyColumn="roomID">
		<![CDATA[
		CREATE  TABLE CHAT_ROOM_#{roomID} (
		`chatID` INT NOT NULL AUTO_INCREMENT ,
  		`sender` INT NOT NULL ,
  		`msg` VARCHAR(100) NULL ,
  		`createDate` DATETIME NULL ,
  		PRIMARY KEY (`chatID`) ,
  		INDEX `idx1` (`createDate` ASC, `sender` ASC) );
  		]]>
	</insert>
	
	<insert id="insertChatRoomUsers" parameterType="java.util.List">
		insert into CHAT_ROOM_USERS (
		ROOM_ID, userNo
		)
		values (
		<foreach item="User" collection="list" open="" close=""
			separator="),(">
			#{User.roomID}, #{User.userNo}
		</foreach>
		)
	</insert>

	<insert id="insertChatMessage" parameterType="com.dy.domain.ChatMessage">
		INSERT INTO CHAT_ROOM_#{roomID}(sender,msg,createDate)
		values(#{sender},#{msg},NOW());
	</insert>
	
	<select id="chatMessages" parameterType="java.util.HashMap" resultType="com.dy.domain.ChatMessage">
		<![CDATA[
		SELECT * FROM (
			SELECT *, #{roomID} as roomID FROM CHAT_ROOM_#{roomID}
			ORDER BY chatID desc
			LIMIT 0, #{fetchCount}
		) A
		WHERE chatID > #{lastChatID}
		ORDER BY chatID
		]]>
	</select>
	
	<select id="chatList" parameterType="com.dy.domain.User" resultType="com.dy.domain.Chat">
		<![CDATA[
		SELECT * FROM CHAT_ROOM_USERS
		WHERE ROOM_ID IN (
			SELECT ROOM_ID FROM CHAT_ROOM_USERS
			WHERE userNo=#{userNo}
		)
		AND userNo <> #{userNo}
		GROUP BY ROOM_ID;
		]]>
	</select>
	
	<select id="lastChatPerUser" parameterType="com.dy.domain.Chat" resultType="java.util.HashMap">
		<![CDATA[
		SELECT * FROM CHAT_ROOM_#{ROOM_ID}
		WHERE msg <> ''
		ORDER BY createDate desc
		LIMIT 0, 1;
		]]>
	</select>
	
	<select id="hometownUserList" parameterType="com.dy.domain.User" resultType="java.util.HashMap">
		<![CDATA[
		select K.userNo, UKD.keywordName, U.*
		from USER_PROFILE_KEYWORD K
		LEFT OUTER JOIN USER_PROFILE_KEYWORD_DIC UKD ON UKD.keywordNo=K.keywordNo
		INNER JOIN USER U on K.userNo=U.userNo
		WHERE UKD.keywordCaregory='고향'
		AND K.userNo <> #{userNo}
		]]>
	</select>
</mapper>