<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.nearhere.taxi">

	<select id="selectCommonValues" resultType="java.util.HashMap">
		select * from common_values;
	</select>
	
	<select id="selectTermsVersion" resultType="java.util.HashMap">
		select A.commonTermsVersion, B.locationTermsVersion
		FROM 
    		(SELECT 1 AS 'PK', value AS 'commonTermsVersion' FROM common_values where name='COMMON_TERMS_VERSION') A,
    		(SELECT 1 AS 'PK', value AS 'locationTermsVersion' FROM common_values where name='LOCATION_TERMS_VERSION') B
		WHERE A.PK=B.PK
	</select>
	
	<select id="selectTermsContent" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select A.COMMON, B.LOCATION, #{commonTermsVersion} as 'commonTermsVersion', #{locationTermsVersion} as 'locationTermsVersion'
		FROM 
    		(SELECT 1 AS 'PK', content AS 'COMMON' FROM terms_content where type='common' and ver=#{commonTermsVersion}) A,
    		(SELECT 1 AS 'PK', content AS 'LOCATION' FROM terms_content where type='location' and ver=#{locationTermsVersion}) B
		WHERE A.PK=B.PK
	</select>
	
	<insert id="insertUserTermsAgreement" parameterType="java.util.HashMap">
		insert into 
		user_terms_agreement ( userID, common_ver, common, location_ver, location, createdDate )
		values (#{userID}, #{common_ver}, #{common}, #{location_ver}, #{location}, NOW()); 
	</insert>
	
	<delete id="deleteUserLocation" parameterType="com.nearhere.domain.UserLocation">
		delete from user_location
		where userID=#{user.userID}
		and locationName=#{locationName}
	</delete>
	
	<insert id="insertUserLocation" parameterType="com.nearhere.domain.UserLocation">
		insert into user_location( userID, locationName, latitude, longitude, address, createdDate )
		values ( #{user.userID}, #{locationName} , #{latitude}, #{longitude}, #{address}, NOW() )
	</insert>
	
	<select id="selectUser" parameterType="com.nearhere.domain.User" resultType="com.nearhere.domain.User">
		select * FROM user where userID = #{userID};
	</select>
	
	<insert id="insertUser" parameterType="com.nearhere.domain.User">
		INSERT INTO user ( userID, userName, password, createdDate )
		VALUES( #{userID}, #{userName}, #{password}, NOW() );
	</insert>
	
	<select id="insertPost" resultType="com.nearhere.domain.Post"
		parameterType="com.nearhere.domain.User">
		insert into post( userID, type, message, content, fromLatitude, fromLongitude, fromAddress,
		latitude, longitude, toAddress, createdDate)
		values(#{user.userID}, 'taxi', #{message}, #{content}, #{fromLatitude}, #{fromLongitude},
		#{fromAddress}, #{latitude}, #{longitude}, #{toAddress}, NOW() );
	</select>
	
	<select id="getPostsNearHere" resultType="com.nearhere.domain.Post"
		parameterType="java.util.HashMap">
		<![CDATA[
		SELECT 
			*
		FROM (
			SELECT P.postID, P.userID, type, message, content, fromLatitude, fromLongitude, fromAddress, 
				latitude, longitude, toAddress, reward, P.createdDate, 
				P.userID as 'user.userID', U.profileImageURL as 'user.profileImageURL',
				U.userName as 'user.userName',
				YEAR(NOW())-YEAR(U.birthday)+1 as 'user.age',
				TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( fromLatitude ) )
  	 	   		* cos( radians( fromLongitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( fromLatitude ) )
   		 		)
  				) , 1)  AS distance, PR.cnt as "replyCount"
			FROM post P
				left outer join (select count(replyID) as 'cnt', postID from post_reply) PR on P.postID=PR.postID
				left outer join user U on P.userID=U.userID
			WHERE fromLatitude is not null
			and fromLongitude is not null
			and type='taxi'
			ORDER BY distance
		) A
		WHERE A.distance <= #{distance}
		LIMIT 0 , 100;
		]]>
	</select>
	
	<select id="getPostDetail" resultType="com.nearhere.domain.Post"
		parameterType="com.nearhere.domain.Post">
		<![CDATA[
		SELECT 
			P.*,
			U.userID as "user.userID",
			U.userName as "user.userName",
			U.profileImageURL as "user.profileImageURL"
		FROM post P
				left outer join user U on P.userID=U.userID
		where type='taxi'
		and postID=#{postID};
		]]>
	</select>
	
	<select id="insertPostReply" parameterType="com.nearhere.domain.PostReply">
		insert into post_reply( postID, userID, message, latitude, longitude, createdDate, type )
		values(#{postID}, #{user.userID}, #{message}, #{latitude}, #{longitude}, NOW(), 'taxi' );
	</select>
	
	<select id="getPostReplies" resultType="com.nearhere.domain.PostReply"
		parameterType="com.nearhere.domain.Post">
		<![CDATA[
		SELECT 
			PR.*,
			U.userID as "user.userID",
			U.userName as "user.userName",
			U.profileImageURL as "user.profileImageURL",
			TRUNCATE((
    			6371 * acos ( cos ( radians( #{fromLatitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{fromLongitude} ) )
   		   		+ sin ( radians( #{fromLatitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
		FROM post_reply PR
			left outer join user U on PR.userID=U.userID
		where PR.postID=#{postID}
		order by PR.createdDate;
		]]>
	</select>
	
	<select id="selectUserPost" resultType="com.nearhere.domain.Post"
		parameterType="com.nearhere.domain.User">
		<![CDATA[
		select P.*,
			U.userID as 'user.userID',
			U.userName as 'user.userName',
			U.profileImageURL as 'user.profileImageURL' 
		from post P
			left outer join user U on P.userID=U.userID
		where P.userID=#{userID} and P.type='taxi';
		]]>
	</select>
	
	<select id="selectPostsUserReplied" parameterType="com.nearhere.domain.User" 
		resultType="com.nearhere.domain.Post">
		select * from post
		where postID in (
  			select postID from post_reply where userID=#{userID}
		)
		and type='taxi';
	</select>
	
	<select id="searchUsers" resultType="com.nearhere.domain.User"
		parameterType="com.nearhere.domain.User">
		<![CDATA[
		SELECT * FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName, U.regID from user_location UL
					LEFT OUTER JOIN user U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 1
		LIMIT 0 , 100;
		]]>
	</select>
	
	<select id="selectUserLocation" parameterType="com.nearhere.domain.User" resultType="com.nearhere.domain.UserLocation">
		select *
		from user_location
		where userID=#{userID}
	</select>
	
	<select id="updateUserSex" parameterType="com.nearhere.domain.User">
		update user set sex=#{sex}
		where userID=#{userID};
	</select>
	
	<select id="updateUserJobTitle" parameterType="com.nearhere.domain.User">
		update user set jobTitle=#{jobTitle}
		where userID=#{userID};
	</select>
</mapper>