<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.nearhere.taxi">

	<select id="selectAppInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
		select * from appInfo where os = #{os} and useYN='Y'
		]]>
	</select>
	
	<insert id="insertUserTermsAgreement" parameterType="java.util.HashMap">
		replace into
		user_terms_agreement ( userID, nearhere_ver, personal_ver,
		location_ver, createdDate )
		values (#{userID}, #{nearhere_ver},
		#{personal_ver}, #{location_ver}, NOW());
	</insert>

	<delete id="deleteUserLocation" parameterType="com.nearhere.domain.UserLocation">
		delete from
		user_location
		where userID=#{user.userID}
		and
		locationName=#{locationName}
	</delete>

	<insert id="insertUserLocation" parameterType="com.nearhere.domain.UserLocation">
		insert into
		user_location( userID, locationName, latitude, longitude, address,
		createdDate )
		values ( #{user.userID}, #{locationName} , #{latitude},
		#{longitude}, #{address}, NOW() )
	</insert>

	<select id="login" parameterType="java.util.HashMap" resultType="com.nearhere.domain.User">
		select * FROM user where userID = #{userID} and password =
		#{password};
	</select>

	<select id="selectUserByUserNo" parameterType="com.nearhere.domain.User"
		resultMap="userWithPoint">
		select *, userID as 'profileID' FROM user where userNo = #{userNo};
	</select>
	
	<select id="selectUserByKakaoID" parameterType="com.nearhere.domain.User"
		resultMap="userWithPoint">
		select *, userID as 'profileID' FROM user where kakaoID = #{kakaoID};
	</select>
	
	<select id="selectUserByFacebookID" parameterType="com.nearhere.domain.User"
		resultMap="userWithPoint">
		select *, userID as 'profileID' FROM user where facebookID = #{facebookID};
	</select>

	<select id="selectUserNoByUUID" parameterType="java.util.HashMap"
		resultType="String">
		select userNo FROM user where uuid = #{UUID};
	</select>

	<select id="selectUser" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.User">
		select * FROM user where userID = #{userID};
	</select>

	<insert id="insertUser" parameterType="com.nearhere.domain.User"
		useGeneratedKeys="true" keyProperty="userNo" keyColumn="userNo">
		INSERT INTO user ( userID, userName, password, uuid, 
			kakaoID, kakaoThumbnailImageURL, kakaoProfileImageURL, type, createdDate )
		VALUES(
		#{userID}, #{userName}, #{password}, #{uuid}, #{kakaoID}, #{kakaoThumbnailImageURL}, #{kakaoProfileImageURL}, #{type}, NOW() );
		<selectKey keyProperty="userNo" resultType="String" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>

	<update id="updateUserID" parameterType="com.nearhere.domain.User">
		update user set
		userID=#{userID}
		where userNo=#{userNo};
	</update>
	
	<update id="updateUserAppVersion" parameterType="com.nearhere.domain.User">
		update user set
		appVersion=#{appVersion}
		where userID=#{userID};
	</update>
	
	<update id="updateKakaoInfo" parameterType="com.nearhere.domain.User">
		update user set
		kakaoID=#{kakaoID}, kakaoThumbnailImageURL = #{kakaoThumbnailImageURL}, kakaoProfileImageURL=#{kakaoProfileImageURL}, userName=#{userName}
		where userNo=#{userNo};
	</update>
	
	<update id="updateFacebookInfo" parameterType="com.nearhere.domain.User">
		update user set
		facebookID = #{facebookID}, facebookProfileImageURL = #{facebookProfileImageURL} , 
		sex = #{sex}, facebookURL = #{facebookURL}, userName = #{userName}, type='Normal',
		registerUserFinished='Y'
		where userNo=#{userNo};
	</update>

	<update id="updateUserSysInfo" parameterType="java.util.HashMap">
		update user set
		appVersion=#{AppVersion}, osVersion = #{OSVersion}, uuid=#{UUID}
		where
		userID=#{userID};
	</update>

	<insert id="insertPost" parameterType="com.nearhere.domain.Post"
		useGeneratedKeys="true" keyProperty="postID" keyColumn="postID">
		insert into post( userID, type, message, content, fromLatitude,
		fromLongitude, fromAddress,
		latitude, longitude, toAddress, sexInfo,
		numOfUsers, departureDate, departureTime, departureDateTime, vehicle, fareOption, repetitiveYN, createdDate)
		values(#{user.userID}, 'taxi', #{message}, #{content},
		#{fromLatitude}, #{fromLongitude},
		#{fromAddress}, #{latitude},
		#{longitude}, #{toAddress}, #{sexInfo}, #{numOfUsers},
		#{departureDate}, #{departureTime}, #{departureDateTime}, #{vehicle}, #{fareOption}, #{repetitiveYN}, #{createdDate} );
		<selectKey keyProperty="postID" resultType="String" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>

	<insert id="insertPostV2" parameterType="java.util.HashMap"
		useGeneratedKeys="true" keyProperty="postID" keyColumn="postID">
		insert into post( userID, type, message, content, fromLatitude,
		fromLongitude, fromAddress,
		latitude, longitude, toAddress, sexInfo,
		numOfUsers, departureDate, departureTime, departureDateTime, vehicle, fareOption, repetitiveYN, region, createdDate)
		values(#{userID}, 'taxi', #{message}, NULL,
		#{fromLatitude}, #{fromLongitude}, #{fromAddress}, #{toLatitude},
		#{toLongitude}, #{toAddress}, #{sexInfo}, #{numOfUsers},
		#{departureDate}, #{departureTime}, #{departureDateTime}, #{vehicle}, #{fareOption}, #{repetitiveYN}, #{region}, NOW() );
		<selectKey keyProperty="postID" resultType="String" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>
	
	<update id="updatePost" parameterType="com.nearhere.domain.Post">
		replace into post( postID,
		userID, type, message, content, fromLatitude, fromLongitude,
		fromAddress,
		latitude, longitude, toAddress, sexInfo, numOfUsers,
		departureDate, departureTime, status, departureDateTime, vehicle, fareOption, repetitiveYN, updatedDate, createdDate )
		values( #{postID},
		#{user.userID}, 'taxi', #{message}, #{content}, #{fromLatitude},
		#{fromLongitude},
		#{fromAddress}, #{latitude}, #{longitude},
		#{toAddress}, #{sexInfo}, #{numOfUsers}, #{departureDate},
		#{departureTime}, #{status}, #{departureDateTime} , #{vehicle}, #{fareOption} , #{repetitiveYN} ,NOW(), NOW() );
	</update>
	
	<update id="updatePostV2" parameterType="com.nearhere.domain.Post">
		update post
		set message = #{message}, fromLatitude = #{fromLatitude}, fromLongitude = #{fromLongitude}, fromAddress = #{fromAddress},
		latitude = #{toLatitude}, longitude = #{toLongitude}, toAddress = #{toAddress}, sexInfo = #{sexInfo}, numOfUsers = #{numOfUsers},
		departureDate = #{departureDate}, departureTime = #{departureTime}, status=#{status}, departureDateTime = #{departureDateTime},
		vehicle=#{vehicle}, fareOption = #{fareOption}, repetitiveYN = #{repetitiveYN}, updatedDate = NOW()
		where postID=#{postID};
	</update>

	<update id="updatePostAsDeleted" parameterType="com.nearhere.domain.Post">
		update post set
		deletedDate=NOW()
		where postID=#{postID}
	</update>
	
	<update id="updatePostStatus" parameterType="com.nearhere.domain.Post">
		update post set
		status=#{status}
		where postID=#{postID}
	</update>
	
	<update id="updatePostDepartureDateTime" parameterType="com.nearhere.domain.Post">
		update post set
		departureDateTime=#{departureDateTime}
		where postID=#{postID}
	</update>

	<update id="updatePostReplyAsDeleted" parameterType="com.nearhere.domain.PostReply">
		update
		post_reply set deletedDate=NOW()
		where replyID=#{replyID}
	</update>
	
	<select id="getPostsNearHere" resultType="com.nearhere.domain.Post"
		parameterType="java.util.HashMap">
		SELECT
		*
		FROM (
			SELECT P.postID, P.userID, P.type, message, content, fromLatitude, fromLongitude, fromAddress,
				latitude, longitude, toAddress, reward, P.createdDate, P.userID as 'user.userID',
				U.profileImageURL as 'user.profileImageURL', U.userName as 'user.userName', U.sex as 'user.sex', U.kakaoID as 'user.kakaoID',
				YEAR(NOW())-YEAR(U.birthday)+1 as 'user.age' , PR.cnt as "replyCount", sexInfo, numOfUsers, departureDate,
				departureTime, departureDateTime
			<if test="fromLatitude != null and fromLongitude != null">
				,TRUNCATE((
				6371 * acos ( cos ( radians( #{fromLatitude} )
				)
				* cos( radians( fromLatitude ) )
				* cos( radians( fromLongitude ) -
				radians( #{fromLongitude} ) )
				+ sin ( radians( #{fromLatitude} ) )
				*
				sin( radians( fromLatitude ) )
				)
				) , 1) AS fromDistance
			</if>
			<if test="toLatitude != null and toLongitude != null">
				,TRUNCATE((
				6371 * acos ( cos ( radians( #{toLatitude} ) )
				* cos( radians( latitude ) )
				* cos( radians( longitude ) - radians(
				#{toLongitude} ) )
				+ sin ( radians( #{toLatitude} ) )
				* sin( radians(
				latitude ) )
				)
				) , 1) AS toDistance
			</if>
				,status, vehicle, fareOption, repetitiveYN, RC.readCount as readCount
			FROM post P
				left outer join (select count(replyID) as 'cnt', postID from post_reply where deletedDate is null group by postID ) PR 
					on P.postID=PR.postID
				left outer join user U on P.userID=U.userID
				left outer join ( select postID, count(postID) as readCount from post_read_history group by postID ) RC 
					on P.postID=RC.postID
			WHERE
			fromLatitude is not null
			and fromLongitude is not null
			and P.type='taxi'
			and deletedDate is null
			<if test="regionNo != null">
				AND P.region = #{regionNo}
			</if>
			<if test="status != null">
				AND P.status = #{status}
			</if>
		) A
		WHERE 1=1
		<if test="postID != null">
			and postID=#{postID}
		</if>
		<if
			test="fromLatitude != null and fromLongitude != null and fromDistance != null">
			AND A.fromDistance &lt;= #{fromDistance}
		</if>
		<if
			test="toLatitude != null and toLongitude != null and toDistance != null">
			AND A.toDistance &lt;= #{toDistance}
		</if>
		<choose>
			<when
				test="fromLatitude != null and fromLongitude != null and toLatitude != null and toLongitude != null">
				order by toDistance, fromDistance, A.status desc, createdDate
				desc
			</when>
			<when test="fromLatitude != null and fromLongitude != null">
				order by fromDistance, A.status desc, createdDate
				desc
			</when>
			<when test="toLatitude != null and toLongitude != null">
				order by A.status desc, toDistance,
				createdDate desc
			</when>
			<otherwise>order by A.status desc, createdDate desc</otherwise>
		</choose>
		LIMIT #{pageStart} , #{pageSize};
	</select>
	
	<select id="getPostCountNearHere" resultType="Integer"
		parameterType="java.util.HashMap">
		SELECT
			count(postID)
		FROM (
		SELECT P.postID, P.userID, P.type, message, content,
		fromLatitude,
		fromLongitude, fromAddress,
		latitude, longitude,
		toAddress, reward, P.createdDate,
		P.userID as 'user.userID',
		U.profileImageURL as 'user.profileImageURL',
		U.userName as
		'user.userName', U.sex as 'user.sex',
		YEAR(NOW())-YEAR(U.birthday)+1 as
		'user.age'
		, PR.cnt as "replyCount",
		sexInfo, numOfUsers, departureDate,
		departureTime
		<if test="fromLatitude != null and fromLongitude != null">
			,TRUNCATE((
			6371 * acos ( cos ( radians( #{fromLatitude} )
			)
			* cos( radians( fromLatitude ) )
			* cos( radians( fromLongitude ) -
			radians( #{fromLongitude} ) )
			+ sin ( radians( #{fromLatitude} ) )
			*
			sin( radians( fromLatitude ) )
			)
			) , 1) AS fromDistance
		</if>
		<if test="toLatitude != null and toLongitude != null">
			,TRUNCATE((
			6371 * acos ( cos ( radians( #{toLatitude} ) )
			* cos( radians( latitude ) )
			* cos( radians( longitude ) - radians(
			#{toLongitude} ) )
			+ sin ( radians( #{toLatitude} ) )
			* sin( radians(
			latitude ) )
			)
			) , 1) AS toDistance
		</if>
		,status
		FROM post P
			left outer join (select count(replyID) as 'cnt',
				postID
				from post_reply
				where deletedDate is null group by postID ) PR on P.postID=PR.postID
			left outer join user U on P.userID=U.userID
		WHERE
		fromLatitude is not null
		and fromLongitude is not null
		and P.type='taxi'
		and deletedDate is null
		) A
		WHERE 1=1
		<if
			test="fromLatitude != null and fromLongitude != null and fromDistance != null">
			AND A.fromDistance &lt;= #{fromDistance}
		</if>
		<if
			test="toLatitude != null and toLongitude != null and toDistance != null">
			AND A.toDistance &lt;= #{toDistance}
		</if>
		<if test="status != null">
			AND A.status = #{status}
		</if>
	</select>

	<select id="getPostDetail" resultType="com.nearhere.domain.Post"
		parameterType="java.util.HashMap">
		<![CDATA[
		SELECT 
			P.*,
			TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( fromLatitude ) )
  	 	   		* cos( radians( fromLongitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( fromLatitude ) )
   		 		)
  				) , 1)  AS distance,
			U.userID as "user.userID",
			U.userName as "user.userName",
			U.profileImageURL as "user.profileImageURL",
			U.sex as "user.sex",
			U.kakaoID as "user.kakaoID",
			U.facebookURL as "user.facebookURL",
			RC.readCount as readCount
		FROM post P
				left outer join user U on P.userID=U.userID
				left outer join ( select postID, count(postID) as readCount from post_read_history group by postID ) RC 
					on P.postID=RC.postID
		where P.type='taxi'
		and P.postID=#{postID};
		]]>
	</select>

	<select id="insertPostReply" parameterType="com.nearhere.domain.PostReply">
		insert into
		post_reply( postID, userID, message, latitude, longitude, createdDate,
		type )
		values(#{postID}, #{user.userID}, #{message}, #{latitude},
		#{longitude}, NOW(), 'taxi' );
	</select>

	<select id="getPostReplies" resultType="com.nearhere.domain.PostReply"
		parameterType="com.nearhere.domain.Post">
		<![CDATA[
		SELECT 
			PR.*,
			U.userID as "user.userID",
			U.userName as "user.userName",
			U.profileImageURL as "user.profileImageURL",
			latitude,
			longitude,
			TRUNCATE((
    			6371 * acos ( cos ( radians( #{fromLatitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{fromLongitude} ) )
   		   		+ sin ( radians( #{fromLatitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
		FROM post_reply PR
			left outer join user U on PR.userID=U.userID
		where PR.postID=#{postID}
		and PR.deletedDate is null
		order by PR.createdDate;
		]]>
	</select>

	<select id="selectUserPost" resultType="com.nearhere.domain.Post"
		parameterType="com.nearhere.domain.User">
		<![CDATA[
		select P.*,
			U.userID as 'user.userID',
			U.userName as 'user.userName',
			U.profileImageURL as 'user.profileImageURL' 
		from post P
			left outer join user U on P.userID=U.userID
		where P.userID=#{userID} and P.type='taxi'
		and P.deletedDate is null;
		]]>
	</select>

	<select id="selectPostsUserReplied" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.Post">
		select P.*,
		U.userID as 'user.userID',
		U.userName as
		'user.userName',
		U.profileImageURL as 'user.profileImageURL'
		from post P
		left outer join user U on P.userID=U.userID
		where postID in (
		select
		postID from post_reply where userID=#{userID} and deletedDate is null
		)
		and P.type='taxi'
		and P.deletedDate is null;
	</select>

	<select id="searchUserCountByDistance" parameterType="java.util.HashMap"
		resultType="Integer">
		<![CDATA[
		SELECT count(userID) FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{fromLatitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{fromLongitude} ) )
   		   		+ sin ( radians( #{fromLatitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName
				from user_location UL
					LEFT OUTER JOIN user U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= #{distance}
		and A.userID <> #{userID}
		and A.userID <> 'admin'
		and A.userName is not null;
		]]>
	</select>
	
	<select id="searchUsersForNewPost" parameterType="java.util.HashMap"
		resultType="com.nearhere.domain.User">
		<![CDATA[
		SELECT * FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{fromLatitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{fromLongitude} ) )
   		   		+ sin ( radians( #{fromLatitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName, U.regID 
				from user_location UL
					LEFT OUTER JOIN user U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= #{distance}
		and A.userID <> #{userID}
		and A.userID <> 'admin'
		and A.userName is not null;
		]]>
	</select>
	
	<select id="searchUsers" parameterType="java.util.HashMap"
		resultMap="userWithPoint">
		<![CDATA[
		SELECT U.userName, 
			U.userID as 'profileID', 
			U.regID, U.profileImageURL, 
			YEAR(NOW())-YEAR(U.birthday)+1 as 'age', 
			U.sex as 'sex', A.*
		FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{fromLatitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{fromLongitude} ) )
   		   		+ sin ( radians( #{fromLatitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*
				from user_location UL
					LEFT OUTER JOIN user U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
			left outer join user U on A.userID=U.userID
		WHERE A.distance <= #{distance}
		and A.userID <> #{userID}
		and A.userID <> 'admin'
		and U.userName is not null
		order by A.distance
		LIMIT #{pageStart} , #{pageSize};
		]]>
	</select>

	<resultMap id="userWithPoint" type="com.nearhere.domain.User">
		<association property="profilePoint" column="profileID"
			javaType="String" select="selectProfilePoint" />
	</resultMap>

	<select id="selectUserLocation" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.UserLocation">
		select *
		from user_location
		where userID=#{userID}
	</select>

	<update id="updateUserSex" parameterType="com.nearhere.domain.User">
		update user set
		sex=#{sex}
		where userID=#{userID};
	</update>

	<update id="updateUserJobTitle" parameterType="com.nearhere.domain.User">
		update user set
		jobTitle=#{jobTitle}
		where userID=#{userID};
	</update>

	<update id="updateUserBirthday" parameterType="com.nearhere.domain.User">
		update user set
		birthday=#{birthday}
		where userID=#{userID};
	</update>

	<select id="selectNoticeList" resultType="com.nearhere.domain.Notice">
		select * from
		notice_list
		order by createdDate desc;
	</select>

	<select id="selectNotice" resultType="com.nearhere.domain.NoticeV2"
		parameterType="String">
		select * from
		notice_list
		where noticeID=#{value}
	</select>

	<select id="selectUnreadNoticeCount" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		select count(noticeID) as unreadNoticeCount, (select max(noticeID) from notice_list) as lastNoticeID from
		notice_list
		<choose>
			<when test="lastNoticeID == null or lastNoticeID == ''">
				where noticeID > 0;
			</when>
			<otherwise>where noticeID > #{lastNoticeID};</otherwise>
		</choose>
	</select>

	<select id="selectUserMessageList" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.UserMessage">
		select A.userID as 'user.userID', U.userName as
		'user.userName', U.profileImageURL as 'user.profileImageURL',
		A.message, A.createdDate, A.isRead
		from (
		select fromUserID as 'userID',
		message, createdDate,
		(
		CASE isRead
		WHEN 'Y' THEN 'true'
		WHEN 'N' THEN
		'false'
		END
		)AS isRead
		from user_message
		where toUserID=#{userID}
		union all
		select toUserID as 'userID', message, createdDate, 'true' AS 'isRead'
		from user_message
		where fromUserID=#{userID}
		) A
		left outer join user U
		on A.userID=U.userID
		order by A.createdDate desc;
	</select>

	<select id="selectUserMessage" parameterType="java.util.HashMap"
		resultType="com.nearhere.domain.UserMessage">
		select
		UM.messageID,
		UM.fromUserID as 'fromUser.userID',
		U.userName as 'fromUser.userName',
		U.profileImageURL as
		'fromUser.profileImageURL',
		UM.toUserID as 'toUser.userID',
		U2.userName
		as 'toUser.userName',
		U2.profileImageURL as 'toUser.profileImageURL',
		UM.message,
		(
		CASE UM.isRead
		WHEN 'Y' THEN 'true'
		WHEN 'N' THEN 'false'
		END
		)AS isRead,
		UM.createdDate
		from
		(
		select messageID, fromUserID,
		toUserID, message, isRead, createdDate
		from user_message
		where
		toUserID=#{userID}
		and fromUserID=#{fromUserID}
		union all
		select
		messageID, fromUserID, toUserID, message, isRead, createdDate
		from
		user_message
		where toUserID=#{fromUserID}
		and fromUserID=#{userID}
		order
		by createdDate desc limit 0,100
		) UM
		left outer join user U on
		UM.fromUserID=U.userID
		left outer join user U2 on UM.toUserID=U2.userID
		order by UM.createdDate
	</select>

	<select id="selectUserPushMessage" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.UserPushMessage">
		select *
		from user_push_message
		where toUserID=#{userID}
		and isRead = 'N'
		order by createdDate desc;
	</select>

	<select id="selectUserSetting" parameterType="com.nearhere.domain.User"
		resultType="com.nearhere.domain.UserSetting">
		select *
		from user_setting
		where userID=#{userID}
	</select>

	<insert id="updateUserSetting" parameterType="com.nearhere.domain.UserSetting">
		replace into
		user_setting( userID, messagePushReceiveYN, replyPushReceiveYN,
		recommendPushReceiveYN, inquiryUserPushReceiveYN, newUserPushReceiveYN, createdDate )
		values (#{userID},
		#{messagePushReceiveYN}, #{replyPushReceiveYN},
		#{recommendPushReceiveYN}, #{inquiryUserPushReceiveYN}, #{newUserPushReceiveYN}, NOW() );
	</insert>

	<update id="updateUserRegID" parameterType="com.nearhere.domain.User">
		update user
		set
		regID=#{regID}, isDeleted = NULL
		where userID=#{userID};
	</update>

	<update id="updateUserRegIDAsNull" parameterType="com.nearhere.domain.User">
		update user
		set
		regID=NULL
		where regID=#{regID};
	</update>

	<insert id="insertUserMessage" parameterType="com.nearhere.domain.UserMessage">
		insert into
		user_message( fromUserID, toUserID, message, isRead, createdDate )
		values(#{fromUser.userID},#{toUser.userID}, #{message}, 'N', NOW());
	</insert>

	<insert id="insertUserPushMessage" parameterType="com.nearhere.domain.UserMessage"
		useGeneratedKeys="true" keyProperty="pushNo" keyColumn="pushNo">
		insert into
		user_push_message( toUserID, message, isRead, type, param1,
		createdDate )
		values(#{toUserID},#{message}, 'N', #{type}, #{param1},
		NOW());
		<selectKey keyProperty="pushNo" resultType="String" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>

	<select id="selectUsersForPost" parameterType="com.nearhere.domain.Post"
		resultType="com.nearhere.domain.User">
		<![CDATA[
			select U.userID, U.regID
			from (
				select userID from post where postID=#{postID}
				union
				select userID from post_reply
				where postID=#{postID}
				and deletedDate is null
			) A
				left outer join user U on A.userID=U.userID
			where A.userID <> #{user.userID}
			and U.regID is not null;
		]]>
	</select>

	<select id="getUnreadCount" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		<![CDATA[
			select sum(messageCount) as 'messageCount', sum(pushCount) as 'pushCount' 
			from (
				select count(messageID) as 'messageCount', 0 as 'pushCount' from user_message where toUserID=#{userID} and isRead = 'N'
            	union all
            	select 0 as 'messageCount', count(pushNo) as 'pushCount' from user_push_message where toUserID=#{userID} and isRead = 'N'
  			) A;
		]]>
	</select>

	<update id="updatePushMessageAsRead" parameterType="com.nearhere.domain.UserPushMessage">
		update
		user_push_message set isRead='Y' where pushNo=#{pushNo};
	</update>

	<update id="updateUserMessageAsRead" parameterType="java.util.HashMap">
		update
		user_message set isRead='Y' where toUserID=#{userID} and
		fromUserID=#{fromUserID};
	</update>

	<update id="updatePushMessageAsRead2" parameterType="java.util.HashMap">
		update
		user_push_message set isRead='Y' where toUserID=#{userID} and
		param1=#{fromUserID};
	</update>

	<update id="updatePushMessageAsRead3" parameterType="java.util.HashMap">
		update
		user_push_message set isRead='Y' where toUserID=#{userID} and
		param1=#{postID};
	</update>
	
	<update id="updatePushMessageAsRead4" parameterType="java.util.HashMap">
		update
		user_push_message set isRead='Y' where toUserID=#{userID}
		and type='inquiryUser' 
		and param1=#{fromUserID};
	</update>

	<update id="updateRegisterUserFinished" parameterType="com.nearhere.domain.User">
		update user set registerUserFinished='Y'
		where userID=#{userID};
	</update>
	
	<update id="updateUserMobileNo" parameterType="com.nearhere.domain.User">
		update user set
		mobileNo=#{mobileNo}
		where
		userID=#{userID};
	</update>
	
	<update id="updateUserName" parameterType="com.nearhere.domain.User">
		update user set
		userName=#{userName}
		where
		userID=#{userID};
	</update>
	
	<update id="updateUserInfo" parameterType="com.nearhere.domain.User">
		update user set
		sex=#{sex}, userName=#{userName}, mobileNo=#{mobileNo}
		where
		userID=#{userID};
	</update>

	<update id="updateUserProfileImage" parameterType="java.util.HashMap">
		update user
		set profileImageURL=#{profileImageURL}
		where userID=#{userID};
	</update>

	<select id="selectProfilePoint" parameterType="com.nearhere.domain.User"
		resultType="String">
		select sum( credit ) as 'profilePoint'
		from (
		select 30 as
		'credit' from user where facebookID is not null and registerUserFinished = 'Y' and userID=#{userID}
		union all
		
		select 20 as
		'credit' from user where kakaoID is not null and registerUserFinished = 'Y' and userID=#{userID}
		union all
		
		select 10 as 'credit' from user where userID=#{userID}
		and birthday is not null
		union all
		
		select 15 as 'credit' from user
		left outer join user_location ul on user.userID=ul.userID and
		ul.locationName='집'
		where user.userID=#{userID}
		and ul.userID is not null
		union all
		
		select 15 as 'credit' from user
		left outer join user_location ul on user.userID=ul.userID and
		ul.locationName='직장'
		where user.userID=#{userID}
		and ul.userID is not null
		union all
		
		select 10 as 'credit' from user where userID=#{userID} and jobTitle is not
		null
		union all
		
		select 0 as 'credit'
		) A
	</select>

	<select id="selectUsersToSendPush" parameterType="java.util.HashMap"
		resultType="com.nearhere.domain.User">
		select * from user
		where regID is not null
		and appVersion > '1.33'
	</select>

	<select id="selectUsersWithUserID" resultType="com.nearhere.domain.User">
		select * from user
		where userID in
		<foreach item="item" index="index" collection="list" open="("
			separator="," close=")">
			#{item}
		</foreach>
		and appVersion >= '1.33'
		and regID is not null
	</select>

	<select id="selectUserWithPushNo" parameterType="String"
		resultType="com.nearhere.domain.User">
		select u.*
		from user_push_message upm
		left outer join user u on u.userID=upm.toUserID
		where upm.pushNo=#{value}
	</select>
	
	<select id="selectInquiryUser" parameterType="java.util.HashMap"
		resultType="com.nearhere.domain.UserPushMessage">
		select *
		from user_push_message
		where type='inquiryUser'
		and param1 = #{userID}
		and toUserID= #{userIDToInquiry}
	</select>
	
	<insert id="insertPostReadHistory" parameterType="java.util.HashMap" >
		insert into post_read_history( postID, userID, createdDate )
		values(#{postID}, #{userID}, NOW() )
	</insert>
	
	<select id="selectPostReadHistory" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		select *
		from post_read_history
		where postID=#{postID}
		and userID= #{userID}
	</select>
	
	<select id="selectLastNewUser" resultType="Integer">
		select ifnull( max( userNo ), 0) from new_user
		where checked='N';
	</select>
	
	<insert id="insertNewUsers" parameterType="java.util.HashMap">
		insert into new_user( userNo, userID, userName, latitude, longitude, address, checked, createdDate )
		select U.userNo, U.userID, U.userName, UL.latitude, UL.longitude, UL.address, 'N', NOW()
		from user U
			left outer join user_location UL on U.userID=UL.userID and UL.locationName='현재위치'
		where userNo > #{maxUserNo}
		limit 0,100;
	</insert>
	
	<select id="selectNewUsers" parameterType="java.util.HashMap" resultType="com.nearhere.domain.NewUser">
		select * from new_user
		where checked='N'
		limit 0,100;
	</select>
	
	<select id="selectUsersNearNewUser" parameterType="com.nearhere.domain.NewUser" resultType="java.util.HashMap">
		<![CDATA[
		select A.*, U.userName, U.regID from (
			SELECT userID, latitude, longitude,
				TRUNCATE((
    					6371 * acos ( cos ( radians( #{latitude} ) )
	     		 		* cos( radians( latitude ) )
  	 	  		 		* cos( radians( longitude ) - radians( #{longitude} ) )
		   		   		+ sin ( radians( #{latitude} ) )
		   		   		* sin( radians( latitude ) )
		   		 		)
  				) , 1)  AS distance
			FROM user_location UL
			where locationName='현재위치'
		) A
		left outer join user U on U.userID=A.userID
		where distance < 1
		]]>
	</select>
	
	<update id="updateNewUserChecked" parameterType="com.nearhere.domain.NewUser">
		update new_user set
		checked='Y'
		where userNo=#{userNo};
	</update>
	
	<update id="updateUserAsDeleted" parameterType="com.nearhere.domain.User">
		update user set
		isDeleted='Y'
		where userID=#{userID};
	</update>
	
	<select id="getMainInfo" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		select R.*, IFNULL(P.regionCount,0) as regionCount, IFNULL(N.newCount,0) as newCount
		from region R
			left outer join (
				select r.parentNo as region, count(*) as regionCount 
				from post p
					left outer join region r on r.regionNo=p.region
				where p.region is not null
				and r.parentNo is not null
				group by r.parentNo
				union
				select p.region, count(*) as regionCount 
				from post p
					left outer join region r on r.regionNo=p.region
				where p.region is not null
				and r.parentNo is null
				group by p.region	
			) P on P.region = R.regionNo
			left outer join (
				SELECT region, count(postID) as newCount from post
				WHERE deletedDate is null
				and createdDate > DATE_SUB( NOW(), INTERVAL 12 DAY )
				group by region
				having count(postID) > 0
			) N on N.region = R.regionNo
		where R.parentNo is null
		order by priority
	</select>
	
	<select id="selectNewUsersCount" resultType="String">
		select count(userNo) as count
		from user u
		where u.createdDate > DATE_FORMAT( DATE_SUB(NOW(),INTERVAL 7 DAY) , '%Y-%m-%d %H:%i:%s')
		and userName is not null
		and u.sex is not null;
	</select>
	
	<select id="selectNewlyRegisteredUsers" resultType="java.util.HashMap">
		select userNo, u.userID, userName, profileImageURL, u.sex, 
			DATE_FORMAT(u.createdDate,'%m-%d') as createdDate, address  from user u
			left outer join user_location ul on u.userID=ul.userID and ul.locationName='현재위치'
		where u.createdDate > DATE_FORMAT( DATE_SUB(NOW(),INTERVAL 7 DAY) , '%Y-%m-%d %H:%i:%s')
		and userName is not null
		and u.sex is not null
		order by u.createdDate desc
		limit 0,5;
	</select>
	
	<select id="selectNewlyRegisteredUsersMore" resultType="java.util.HashMap">
		select userNo, u.userID, userName, profileImageURL, u.sex, 
			DATE_FORMAT(u.createdDate,'%m-%d') as createdDate, address  from user u
			left outer join user_location ul on u.userID=ul.userID and ul.locationName='현재위치'
		where u.createdDate > DATE_FORMAT( DATE_SUB(NOW(),INTERVAL 7 DAY) , '%Y-%m-%d %H:%i:%s')
		and userName is not null
		and u.sex is not null
		order by u.createdDate desc
		limit 0,50;
	</select>
	
	<select id="selectProgressingPosts" resultType="java.util.HashMap">
		<![CDATA[
			select p.postID, p.message, DATE_FORMAT( p.departureDateTime , '%Y-%m-%d %H:%i:%s') as departureDateTime, p.userID,
				u.userName, u.profileImageURL
			from post p
				left outer join user u on p.userID=u.userID
			where p.type='taxi'
			and p.status='진행중'
			and p.deletedDate is null
		]]>
	</select>
	
	<select id="selectMyPosts" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
			select p.postID, p.message, DATE_FORMAT( p.departureDateTime , '%Y-%m-%d %H:%i:%s') as departureDateTime, p.userID,
				u.userName, u.profileImageURL
			from post p
				left outer join user u on p.userID=u.userID
			where p.userID=#{userID}
			and p.type='taxi'
			and p.deletedDate is null
		]]>
	</select>
	
	<select id="selectPostsWithin1Week" resultType="java.util.HashMap">
		<![CDATA[
			select p.postID, p.message, DATE_FORMAT( p.departureDateTime , '%Y-%m-%d %H:%i:%s') as departureDateTime, p.userID,
				u.userName, u.profileImageURL
			from post p
				left outer join user u on p.userID=u.userID
			where p.departureDateTime >= DATE_FORMAT( DATE_SUB(NOW(),INTERVAL 7 DAY) , '%Y-%m-%d %H:%i:%s')
			and p.type='taxi'
			and p.deletedDate is null
			order by p.createdDate desc;
		]]>
	</select>
	
	<select id="selectPostsNearHereV2" resultType="java.util.HashMap">
		<![CDATA[
			select * from (
				select p.postID, p.message, DATE_FORMAT( p.departureDateTime , '%Y-%m-%d %H:%i:%s') as departureDateTime, p.userID,
					u.userName, u.profileImageURL
					,TRUNCATE((
						6371 * acos ( cos ( radians( #{fromLatitude} ) ) * cos( radians( fromLatitude ) )
						* cos( radians( fromLongitude ) - radians( #{fromLongitude} ) )
						+ sin ( radians( #{fromLatitude} ) ) * sin( radians( fromLatitude ) )
						) ) , 1) AS distance
				from post p
					left outer join user u on p.userID=u.userID
				where p.type='taxi'
				and p.deletedDate is null
			) A
			where distance <= 5;
		]]>
	</select>
	
	<select id="selectPostsInRegion" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
			select p.postID, p.message, DATE_FORMAT( p.departureDateTime , '%Y-%m-%d %H:%i:%s') as departureDateTime, p.userID,
				u.userName, u.profileImageURL
			from post p
				left outer join user u on p.userID=u.userID
			where p.toAddress like CONCAT('%',#{regionName},'%') 
			and p.type='taxi'
			and p.deletedDate is null
			order by p.createdDate desc;
		]]>
	</select>
	
	<select id="getEventAppliedInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		<![CDATA[
			select * from event_apply
			where eventSeq=#{eventSeq}
			and userID=#{userID}
			and deletedDate is null;
		]]>
	</select>
	
	<insert id="insertEventApplyInfo" parameterType="java.util.HashMap">
		insert into event_apply( eventSeq, userID, phoneNo, pushNo, param1, createdDate )
		values(#{eventSeq}, #{userID}, #{phoneNo}, #{pushNo}, #{param1}, NOW());
	</insert>
	
	<insert id="insertUserToken" parameterType="java.util.HashMap">
		insert into user_token( userID, seed, hash, expireDate, activeYN, createdDate )
		values ( #{userID}, #{seed}, #{hash}, NOW() + INTERVAL 20 DAY, 'Y', NOW() );
	</insert>
	
	<delete id="deleteUserToken" parameterType="java.util.HashMap">
		delete from user_token where userID=#{userID}
	</delete>
	
	<select id="selectUserToken" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select * from user_token where userID=#{userID} and hash=#{hash} and activeYN='Y';
	</select>
	
	<update id="updateUserTokenAsLogout" parameterType="com.nearhere.domain.User">
		update user_token set activeYN='N' where userID=#{userID}
	</update>
	
	<update id="updateUserTokenAsLogIn" parameterType="com.nearhere.domain.User">
		update user_token set activeYN='Y' where userID=#{userID}
	</update>
	
	<update id="updateUserType" parameterType="com.nearhere.domain.User">
		update user set type=#{type} where userID=#{userID}
	</update>
	
	<update id="updateUserTypeAsNormal" parameterType="com.nearhere.domain.User">
		update user set type='Normal' where userID=#{userID} and ( kakaoID is not null or facebookURL is not null)
	</update>
	
	<select id="registerUserFinishedInfo" resultType="java.util.HashMap" parameterType="com.nearhere.domain.User">
		select u.sex , u.userName, u.kakaoID, ua.userID as agreementUserID, u.registerUserFinished
		from user u
			left outer join user_terms_agreement ua on u.userID=ua.userID
		where u.userID=#{userID};
	</select>
	
	<update id="deleteKakaoInfo" parameterType="com.nearhere.domain.User">
		update user set kakaoID=null, kakaoThumbnailImageURL=null, kakaoProfileImageURL=null, registerUserFinished=null where userID=#{userID}
	</update>
	
	<update id="deleteFacebookInfo" parameterType="com.nearhere.domain.User">
		update user set facebookID=null, facebookURL=null, facebookProfileImageURL=null, registerUserFinished=null where userID=#{userID}
	</update>
	
	<insert id="insertUserDestination" parameterType="java.util.HashMap">
		insert into user_destinations(destination, userID, createdDate)
		SELECT #{destination}, #{userID}, NOW() from user_destinations
		WHERE NOT EXISTS (
    		select destinationNo from user_destinations
    		where userID=#{userID} and destination = #{destination}
		) LIMIT 1;
	</insert>
	
	<select id="selectUserDestinations" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select * from user_destinations
		group by destination
		order by count(destinationNo) desc
	</select>
	
	<select id="getRegionList" resultType="java.util.HashMap">
		select * from region
		where parentNo is null
		order by priority
	</select>
	
</mapper>