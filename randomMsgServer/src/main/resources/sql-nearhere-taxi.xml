<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.nearhere.taxi">

	<select id="selectCommonValues" resultType="java.util.HashMap">
		select * from common_values;
	</select>
	
	<select id="selectTermsVersion" resultType="java.util.HashMap">
		select A.commonTermsVersion, B.locationTermsVersion
		FROM 
    		(SELECT 1 AS 'PK', value AS 'commonTermsVersion' FROM common_values where name='COMMON_TERMS_VERSION') A,
    		(SELECT 1 AS 'PK', value AS 'locationTermsVersion' FROM common_values where name='LOCATION_TERMS_VERSION') B
		WHERE A.PK=B.PK
	</select>
	
	<select id="selectTermsContent" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select A.COMMON, B.LOCATION, #{commonTermsVersion} as 'commonTermsVersion', #{locationTermsVersion} as 'locationTermsVersion'
		FROM 
    		(SELECT 1 AS 'PK', content AS 'COMMON' FROM terms_content where type='common' and ver=#{commonTermsVersion}) A,
    		(SELECT 1 AS 'PK', content AS 'LOCATION' FROM terms_content where type='location' and ver=#{locationTermsVersion}) B
		WHERE A.PK=B.PK
	</select>
	
	<insert id="insertUserTermsAgreement" parameterType="java.util.HashMap">
		insert into 
		user_terms_agreement ( userID, common_ver, common, location_ver, location, createdDate )
		values (#{userID}, #{common_ver}, #{common}, #{location_ver}, #{location}, NOW()); 
	</insert>
	
	<delete id="deleteUserLocation" parameterType="com.nearhere.domain.UserLocation">
		delete from user_location
		where userID=#{userID}
		and locationName=#{locationName}
	</delete>
	
	<insert id="insertUserLocation" parameterType="com.nearhere.domain.UserLocation">
		insert into user_location( userID, locationName, latitude, longitude, createdDate )
		values ( #{userID}, #{locationName} , #{latitude}, #{longitude}, NOW() )
	</insert>
	
	<select id="selectUser" parameterType="com.nearhere.domain.User" resultType="com.nearhere.domain.User">
		select * FROM user where userID = #{userID};
	</select>
	
	<insert id="insertUser" parameterType="com.nearhere.domain.User">
		INSERT INTO user ( userID, userName, password, createdDate )
		VALUES( #{userID}, #{userName}, #{password}, NOW() );
	</insert>
	
	<select id="searchUsers" resultType="com.nearhere.domain.User"
		parameterType="com.nearhere.domain.User">
		<![CDATA[
		SELECT * FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName, U.regID from user_location UL
					LEFT OUTER JOIN user U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 1
		LIMIT 0 , 100;
		]]>
	</select>
	
</mapper>