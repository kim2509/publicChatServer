<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.nearhere.taxi">

	<select id="searchUser" resultType="com.nearhere.domain.User"
		parameterType="com.nearhere.domain.User">
		<![CDATA[
		SELECT * FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName, U.regID from user_location UL
					LEFT OUTER JOIN USER U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 1
		LIMIT 0 , 100;
		]]>
	</select>
	
</mapper>