<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.neighborhood">

	<select id="getPostCount" resultType="int"
		parameterType="com.neighborhood.domain.User">
		<![CDATA[
		SELECT count(postID) FROM (
		SELECT *, TRUNCATE((
    		6371 * acos ( cos ( radians( #{latitude} ) )
      		* cos( radians( latitude ) )
      		* cos( radians( longitude ) - radians( #{longitude} ) )
      		+ sin ( radians( #{latitude} ) )
      		* sin( radians( latitude ) )
    		)
  			) , 1)  AS distance
			FROM post
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 5;
		]]>
	</select>
	
	<select id="getAllPosts" resultType="com.neighborhood.domain.Post"
		parameterType="com.neighborhood.domain.User">
		<![CDATA[
		SELECT * FROM (
		SELECT post.*, 
			TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
      			* cos( radians( latitude ) )
      			* cos( radians( longitude ) - radians( #{longitude} ) )
      			+ sin ( radians( #{latitude} ) )
      			* sin( radians( latitude ) )
    			)
  			) , 1)  AS distance,
  			U.userID as "user.userID",
			U.userName as "user.userName",
			U.profileImageURL as "user.profileImageURL"
			FROM post
				LEFT OUTER JOIN user U ON post.userID = U.userID
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 5
		LIMIT 0 , 5;
		]]>
	</select>

	<update id="updateUserRegID" parameterType="com.neighborhood.domain.User">
		UPDATE
		user SET regID=#{regID} where
		userID=#{userID}
	</update>
	
	<update id="updateUserLocation" parameterType="com.neighborhood.domain.User">
		UPDATE
		user_location SET latitude=#{latitude}, longitude=#{longitude} where
		userID=#{userID}
		and locationName='현재위치'
	</update>

	<select id="getPostDetail" resultType="com.neighborhood.domain.Post"
		parameterType="com.neighborhood.domain.Post">
		<![CDATA[
		SELECT P.*,
		U.userID as "user.userID",
		U.userName as "user.userName",
		U.profileImageURL as "user.profileImageURL"
		from post P
			LEFT OUTER JOIN user U on P.userID=U.userID
		WHERE postID=#{postID}
		]]>
	</select>

	<select id="getPostLikes" resultType="com.neighborhood.domain.PostLike"
		parameterType="com.neighborhood.domain.Post">
		<![CDATA[
		SELECT *,U.userName FROM post_like PL
		LEFT OUTER JOIN user U on PL.userID=U.userID
		WHERE postID=#{postID}
		]]>
	</select>

	<select id="getPostReplies" resultType="com.neighborhood.domain.PostReply"
		parameterType="com.neighborhood.domain.Post">
		<![CDATA[
		SELECT *,
			U.userName as "user.userName",
			U.userID as "user.userID",
			U.profileImageURL as "user.profileImageURL",
			PR.distance
		FROM post_reply PR
			LEFT OUTER JOIN user U ON PR.userID=U.userID
		WHERE postID=#{postID}
		]]>
	</select>

	<insert id="addPostReply" parameterType="com.neighborhood.domain.PostReply">
		INSERT INTO post_reply(
		postID, userID, message, createDate )
		VALUES( #{postID}, #{userID},
		#{message}, NOW() );
	</insert>

	<insert id="addPostLike" parameterType="com.neighborhood.domain.PostLike">
		INSERT INTO post_like(
		postID, userID, createDate )
		VALUES( #{postID}, #{userID}, NOW() );
	</insert>

	<insert id="addPost" parameterType="com.neighborhood.domain.Post">
		INSERT INTO post( userID,
		message, latitude, longitude, createDate )
		VALUES( #{userID},
		#{message}, #{latitude}, #{longitude}, NOW() );
		<selectKey keyProperty="postID" resultType="String" order="AFTER">
			select LAST_INSERT_ID();
		</selectKey>
	</insert>

	<select id="getUser" resultType="com.neighborhood.domain.User"
		parameterType="com.neighborhood.domain.User">
		<![CDATA[
		SELECT * FROM user
		WHERE userID=#{userID}
		]]>
	</select>

	<insert id="insertUser" parameterType="com.neighborhood.domain.User">
		INSERT INTO user( userID,
		userName, regID, createDate )
		VALUES( #{userID},#{userName},#{regID},
		NOW() );
	</insert>

	<insert id="insertUserLocation" parameterType="com.neighborhood.domain.UserLocation">
		INSERT INTO
		user_location( userID, latitude, longitude, locationName, priority )
		VALUES( #{userID},#{latitude},#{longitude},#{locationName},
		#{priority} );
	</insert>

	<select id="getNearUsers" resultType="com.neighborhood.domain.User"
		parameterType="com.neighborhood.domain.Post">
		<![CDATA[
		SELECT * FROM (
			SELECT *, TRUNCATE((
    			6371 * acos ( cos ( radians( #{latitude} ) )
	      		* cos( radians( latitude ) )
  	 	   		* cos( radians( longitude ) - radians( #{longitude} ) )
   		   		+ sin ( radians( #{latitude} ) )
   		   		* sin( radians( latitude ) )
   		 		)
  				) , 1)  AS distance
			FROM (
				select UL.*, U.userName, U.regID from user_location UL
					LEFT OUTER JOIN USER U ON UL.userID=U.userID
				where locationName='현재위치'
			) A
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 1
		LIMIT 0 , 100;
		]]>
	</select>

	<select id="getPostAuthor" parameterType="com.neighborhood.domain.PostReply"
	    resultType="com.neighborhood.domain.User">
	    <![CDATA[
		select P.userID,U.userName, U.regID from post P
		LEFT OUTER JOIN user U on P.userID=U.userID
		where postID=#{postID}
		and P.userID <> #{userID}
		]]>
	</select>
	
	<select id="getPostAuthor2" parameterType="com.neighborhood.domain.PostLike"
	    resultType="com.neighborhood.domain.User">
	    <![CDATA[
		select P.userID,U.userName, U.regID from post P
		LEFT OUTER JOIN user U on P.userID=U.userID
		where postID=#{postID}
		and P.userID <> #{userID}
		]]>
	</select>

	<select id="getPostReplyUsers" parameterType="com.neighborhood.domain.PostReply"
	    resultType="com.neighborhood.domain.User">
	    <![CDATA[
		select P.userID,U.userName, U.regID from post_reply P
		LEFT OUTER JOIN user U on P.userID=U.userID
		where postID=#{postID}
		group by P.userID
		]]>
	</select>
	
	<select id="getAllUsers" resultType="com.neighborhood.domain.User">
		<![CDATA[
		SELECT * FROM user;
		]]>
	</select>
	
	<select id="getAllUserLocation" resultType="com.neighborhood.domain.UserLocation">
		<![CDATA[
		SELECT * FROM user_location;
		]]>
	</select>
	
</mapper>