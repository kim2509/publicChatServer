<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tessoft.neighborhood">

    <select id="getAllPosts" resultType="com.neighborhood.domain.Post"
		parameterType="com.neighborhood.domain.User">
		<![CDATA[
		SELECT * FROM (
		SELECT *, TRUNCATE((
    		6371 * acos ( cos ( radians( #{latitude} ) )
      		* cos( radians( latitude ) )
      		* cos( radians( longitude ) - radians( #{longitude} ) )
      		+ sin ( radians( #{latitude} ) )
      		* sin( radians( latitude ) )
    		)
  			) , 1)  AS distance
			FROM POST
			WHERE latitude is not null
			and longitude is not null
			ORDER BY distance
		) A
		WHERE A.distance <= 10
		LIMIT 0 , 20;
		]]>
	</select>
	
    <update id="updateUserLocation" parameterType="com.neighborhood.domain.User">
		UPDATE
		USER_LOCATION SET latitude=#{latitude}, longitude=#{longitude} where
		userID=#{userID}
	</update>
	
    <select id="getPostDetail" resultType="com.neighborhood.domain.Post"
		parameterType="com.neighborhood.domain.Post">
		<![CDATA[
		SELECT P.*,U.userName 
		from POST P
			LEFT OUTER JOIN USER U on P.userID=U.userID
		WHERE postID=#{postID}
		]]>
	</select>
	
</mapper>